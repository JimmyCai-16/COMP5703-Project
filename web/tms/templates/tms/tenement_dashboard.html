{% extends 'appboard/base.html' %}
{% load static %}
{% load modal_tags %}
{% load project_tags %}
{% load humanize %}

{% block head_title %}
    {{ tenement.permit_id }}
{% endblock %}

{% block extra_head %}
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

    {# MAP CSS #}
    <link rel="stylesheet" href="{% static "interactive_map/css/api.css" %}"/>

    {% csrf_token %}
{% endblock %}


{% block breadcrumb %}
    {% with tenement.project as project %}
        {% if project and project|is_read:member %}
            <a class="nav-link" href="{% url 'project:index' %}">Project Index</a> /
            <a class="nav-link" href="{% url 'project:dashboard' slug=project.slug %}">{{ project.name }}</a> /
            <a class="nav-link" href="#">{{ tenement.permit_id }}</a>
        {% endif %}
    {% endwith %}
{% endblock %}

{% block content %}
    <div
            id="flash-message" class="text-md ms-4">
        {% if messages %}
            {% for message in messages %}
                {% if message.level == 25 %}
                    <div
                            class="alert alert-success p-3"> {{ message }}
    </div>
                {% elif message.level == 40 %}
                    <div
                            class="alert alert-danger p-3"> {{ message }}
    </div>
                {% endif %} {% endfor %} {% endif %}
    </div>

    <div class="container-fluid px-4">
        <div class="row text-center mb-2 content-margin-top-offest">
            <h4 class="mb-4 text-ofx-blue">{{ tenement.permit_id }}<i class="fa-solid fa-earth-oceania ms-2"></i></h4>
        </div>
        <div class="row row-cols g-3">
            <div class="col-sm-12 col-xl-8">
                <div class="row g-3">

                    <div class="col-12">
                        {# INFO: MAIN NAV #}
                        <div class="card shadow mb-2">
                            <div class="card-header">
                                <div class="nav nav-tabs card-header-tabs" id="nav-tab" rolelist="tablist">
                                    <a class="nav-link active" id="nav-permit-tab" data-bs-toggle="tab"
                                       data-bs-target="#nav-permit" aria-controls="nav-permit" aria-selected="true">
                                        Permit Info
                                    </a>
                                    <a class="nav-link" id="nav-holders-tab" data-bs-toggle="tab"
                                       data-bs-target="#nav-holders" aria-controls="nav-holders" aria-selected="false">
                                        Holders
                                    </a>
                                    <a class="nav-link" id="nav-permit-info-tab" data-bs-toggle="tab"
                                       data-bs-target="#nav-area" aria-controls="nav-area" aria-selected="false">
                                        Area
                                    </a>
                                    {% if tenement.project|is_read:member %}
                                        <a class="nav-link" id="nav-permit-info-tab" data-bs-toggle="tab"
                                           data-bs-target="#nav-targets" aria-controls="nav-targets"
                                           aria-selected="false">
                                            Prospects
                                        </a>
                                    {% endif %}
                                </div>
                            </div>

                            <div class="card-body tab-content overflow-auto" id="nav-tabContent">
                                <div class="tab-pane active col-12" id="nav-permit" role="tabpanel"
                                     aria-labelledby="nav-permit-tab">
                                    <div class="row">
                                        <div class="col col-sm-12 col-xl-6">
                                            <h4 class="mt-2 fw-bold">Tenement Permit</h4>
                                            <table class="table table-sm p-dash-table">
                                                <colgroup>
                                                    <col span="1" style="width: 25%">
                                                    <col span="1" style="width: 75%">
                                                </colgroup>
                                                <tbody>
                                                <tr>
                                                    <th>Tenement ID</th>
                                                    <td>{{ tenement.permit_id }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Tenement Type</th>
                                                    <td>{{ tenement.get_permit_type_display }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Status</th>
                                                    <td>{{ tenement.get_permit_status_display }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Lodged Date</th>
                                                    <td>{{ tenement.date_lodged }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Approved Date</th>
                                                    <td>{{ tenement.date_granted }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Commencement Date</th>
                                                    <td>{{ tenement.date_commenced }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Expiry Date</th>
                                                    <td>{{ tenement.date_expiry }}</td>
                                                </tr>
                                                <tr>
                                                    <th>Current Term</th>
                                                    <td>{% if tenement.term_current %}Term
                                                        {{ tenement.term_current }}{% endif %}</td>
                                                </tr>
                                                {% if tenement.date_expiry %}
                                                    <tr>
                                                        <th>Expires In</th>
                                                        <td>
                                                            {% if tenement.expiry_distance.0 > 0 %}
                                                                {{ tenement.expiry_distance.0 }}y
                                                            {% endif %}
                                                            {% if tenement.expiry_distance.1 > 0 %}
                                                                {{ tenement.expiry_distance.1 }}m
                                                            {% endif %}
                                                            {% if tenement.expiry_distance.2 > 0 %}
                                                                {{ tenement.expiry_distance.2 }}d
                                                            {% endif %}
                                                        </td>
                                                    </tr>
                                                {% endif %}
                                                </tbody>
                                            </table>
                                        </div>
                                        {% if tenement.environmental_authority %}
                                            {% with tenement.environmental_authority as EA %}
                                                <div class="col col-sm-12 col-xl-6">
                                                    <h4 class="mt-2 fw-bold">Environmental Authority</h4>
                                                    <table class="table table-sm p-dash-table">
                                                        <colgroup>
                                                            <col span="1" style="width: 25%">
                                                            <col span="1" style="width: 75%">
                                                        </colgroup>
                                                        <tbody>
                                                        <tr>
                                                            <th>EA Permit ID</th>
                                                            <td>{{ EA.number }}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Status</th>
                                                            <td>{{ EA.get_status_display }}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Permit Type</th>
                                                            <td>{{ EA.type }}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Condition Type</th>
                                                            <td>{{ EA.condition_type }}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Activity</th>
                                                            <td>{{ EA.activity }}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Permit Holder(s)</th>
                                                            <td>{{ EA.holder }}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Effective Date</th>
                                                            <td>{{ EA.date_effective }}</td>
                                                        </tr>
                                                        <tr>
                                                            <th>Assurance</th>
                                                            <td>{{ EA.assurance }}</td>
                                                        </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            {% endwith %}
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="tab-pane" id="nav-holders" role="tabpanel"
                                     aria-labelledby="nav-holders-tab">
                                    <h4 class="mt-2 fw-bold">Authorised Holder Representative (AHR)</h4>
                                    <table class="table table-sm p-dash-table">
                                        <colgroup>
                                            <col span="1" style="width: 15%">
                                            <col span="1" style="width: 85%">
                                        </colgroup>
                                        <tbody>
                                        <tr>
                                            <th>Name</th>
                                            <td>{{ tenement.ahr_name }}</td>
                                        </tr>
                                        <tr>
                                            <th>Address</th>
                                            <td>{{ tenement.ahr_address }}</td>
                                        </tr>
                                        </tbody>
                                    </table>

                                    <h4 class="mt-4 fw-bold">Holders</h4>
                                    <table class="table table-sm p-dash-table">
                                        <thead>
                                        <th>Holder Name</th>
                                        <th>Share %</th>
                                        <th>Status</th>
                                        <th>Held From</th>
                                        <th>Held To</th>
                                        <th>AH</th>
                                        </thead>
                                        <tbody>
                                        {% for holder in tenement.holders.all %}
                                            <tr>
                                                <td>{{ holder.name_main }}<br/>{{ holder.address }}</td>
                                                <td>{{ holder.share_percent }}</td>
                                                <td>{{ holder.get_status_display }}</td>
                                                <td>{{ holder.date_start }}</td>
                                                <td>{{ holder.date_end }}</td>
                                                <td>{% if holder.is_authorised_holder %}
                                                    <span class="fa fa-check text-ofx-green"/>
                                                {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                                <div class="tab-pane" id="nav-area" role="tabpanel" aria-labelledby="nav-area-tab">
                                    <h4 class="mt-2 fw-bold">Tenement Area Information</h4>
                                    <table class="table table-sm p-dash-table">
                                        <colgroup>
                                            <col span="1" style="width: 15%">
                                            <col span="1" style="width: 85%">
                                        </colgroup>
                                        <tbody>
                                        <tr>
                                            <th>Mining District</th>
                                            <td>{{ tenement.area_mining_district }}</td>
                                        </tr>
                                        <tr>
                                            <th>Local Authority</th>
                                            <td>{{ tenement.area_local_authority }}</td>
                                        </tr>
                                        <tr>
                                            <th>Area</th>
                                            <td>{{ tenement.area_units }} {{ tenement.area_label }}</td>
                                        </tr>
                                        <tr>
                                            <th>Rent/unit Area</th>
                                            <td>${{ tenement.rent_rate }}</td>
                                        </tr>
                                        <tr>
                                            <th>Exclusions</th>
                                            <td>{{ tenement.area_exclusions }}</td>
                                        </tr>
                                        <tr>
                                            <th>Prescribed Minerals</th>
                                            <td>{{ tenement.prescribed_minerals|join:',' }}</td>
                                        </tr>
                                        </tbody>
                                    </table>
                                    {% if tenement.blocks.all|length %}
                                        <h4 class="mt-4 fw-bold">Sub-Blocks</h4>
                                        <table class="table table-sm p-dash-table">
                                            <thead>
                                            <th>Block</th>
                                            {% for id in "ABCDEFGHJKLMNOPQRSTUVWXYZ" %}
                                                <th class="text-center">{{ id }}</th>
                                            {% endfor %}
                                            </thead>
                                            <tbody>
                                            {% for block in tenement.blocks.all %}
                                                <tr>
                                                    {# Loops through each block and places a checkmark in the columns for each subblock if exists #}
                                                    <td>{{ block.get_block_identification_map_display }} {{ block.number }}</td>
                                                    {% for sub_block, value in block.sub_blocks.items %}
                                                        <td class="text-center">
                                                            {% if value %}
                                                                <span class="fa fa-check text-ofx-blue"/>
                                                            {% endif %}
                                                        </td>
                                                    {% endfor %}
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    {% endif %}
                                </div>

                                {% if tenement.project|is_read:member %}
                                    <div class="tab-pane" id="nav-targets" role="tabpanel"
                                         aria-labelledby="nav-targets-tab">
                                        <table id="target-table" class="table table-sm dt-responsive w-100">
                                            <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Description</th>
                                                <th>Location (Lat/Long)</th>
                                                <th>
                                                    {% if tenement.project|is_admin:member %}
                                                        <span data-bs-toggle="modal"
                                                              data-bs-target="#addEditTargetModal">
                                                            <button id="addTargetButton"
                                                                    class="btn btn-ofx-fa btn-ofx-green float-end text-xs"
                                                                    data-bs-toggle="tooltip" data-bs-placement="left"
                                                                    title="Add Prospect">
                                                                <span class="fa fa-plus"></span>
                                                            </button>
                                                        </span>
                                                    {% endif %}
                                                </th>
                                            </tr>
                                            </thead>
                                            <tbody>

                                            </tbody>
                                        </table>

                                    </div>
                                {% endif %}
                            </div>

                        </div>
                        {# UTILITY BAR #}
                        <div class="float-end">
                            {# Is Project Member #}
                            {% if tenement.project %}
                                {% if tenement.project|is_read:member %}
                                    <button class="btn btn-sm btn-ofx-blue" type="button"
                                            onclick="window.location.href='{% url 'project:dashboard' slug=tenement.project.slug %}';">
                                        {{ tenement.project.name }} <span class="fa fa-chalkboard"/>
                                    </button>
                                    {% comment %} <button class="btn btn-sm btn-ofx-blue" type="button">KMS <span
                                            class="fa fa-comment"/>
                                    </button> {% endcomment %}

                                    {# Owner Only #}
                                    {% comment %} {% if tenement.project|is_admin:member %}
                                        <button class="btn btn-sm btn-ofx-gray" type="button"
                                                data-bs-toggle="modal"
                                                data-bs-target="#modifyTenementModal">
                                            Modify <span class="fa fa-cog"/>
                                        </button>
                                    {% endif %} {% endcomment %}
                                    {% if tenement.project|is_owner:member %}
                                        <button class="btn btn-sm btn-ofx-red" type="button"
                                                data-bs-toggle="modal"
                                                data-bs-target="#deleteTenementModal">
                                            Relinquish <span class="fa fa-trash"/></button>
                                    {% endif %}

                                    {# Is Not in Project Members #}
                                {% else %}
                                    <button class="btn btn-sm btn-ofx-gray" type="button" disabled>Already Claimed
                                    </button>
                                {% endif %}
                            {% else %}
                                {# Is Unclaimed #}
                                <button class="btn btn-sm btn-ofx-green" type="button"
                                        data-bs-toggle="modal"
                                        data-bs-target="#claimTenementModal">
                                    Add to Project <span class="fa fa-plus"/>
                                </button>
                            {% endif %}
                        </div>
                    </div>

                    {% if tenement.project|is_read:member %}
                        {# Appear in screen smaller than xl. Disappear otherwise #}
                        <div id="statistics_div_small" class="col-12">
                        </div>

                        {# PENDING TASKS #}
                        <div class="col-12">
                            <div class="card shadow mb-2">
                                <div class="card-header">
                                    Pending Tasks
                                </div>
                                <div class="card-body">
                                    <table id="task-table" class="table table-sm dt-responsive w-100">
                                        <thead>
                                        <th>Name</th>
                                        <th>Description</th>
                                        <th>Authority</th>
                                        <th>Due Date</th>
                                        <th>Attachment(s)</th>
                                        <th>
                                            {% if tenement.project|is_admin:member %}
                                                <span data-bs-toggle="modal" data-bs-target="#createTaskModal">
                                            <button class="btn btn-ofx-fa btn-ofx-green float-end text-xs"
                                                    data-bs-toggle="tooltip" data-bs-placement="left" title="Add Task">
                                                <span class="fa fa-plus"/>
                                            </button>
                                        </span>
                                            {% endif %}
                                        </th>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        {# WORK PROGRAM #}
                        <div class="col-12">
                            <div class="card shadow mb-2">
                                <div class="card-header">
                                    <span>Work Program</span>
                                    <div class="nav nav-tabs card-header-tabs" id="work-program-tab" rolelist="tablist">
                                        <a class="nav-link active" id="work-program-summary-total-tab"
                                           data-bs-toggle="tab"
                                           data-bs-target="#work-program-summary-total"
                                           aria-controls="work-program-summary-total" aria-selected="true">
                                            Summary Totals
                                        </a>
                                        <a class="nav-link" id="work-program-yearly-total-tab" data-bs-toggle="tab"
                                           data-bs-target="#work-program-yearly-total"
                                           aria-controls="work-program-yearly-total" aria-selected="false">
                                            Yearly Totals
                                        </a>
                                        <a class="nav-link" id="work-program-activties-tab" data-bs-toggle="tab"
                                           data-bs-target="#work-program-activity"
                                           aria-controls="work-program-activities" aria-selected="false">
                                            Activities
                                        </a>
                                    </div>
                                </div>
                                <div class="card-body tab-content overflow-auto" id="work-program-tabContent">

                                    <div class="tab-pane active col-12" id="work-program-summary-total" role="tabpanel"
                                         aria-labelledby="nav-holders-tab">
                                        <table id="summary-total-table" class="table table-sm dt-responsive w-100">
                                        </table>
                                    </div>
                                    <div class="tab-pane" id="work-program-yearly-total" role="tabpanel"
                                         aria-labelledby="nav-holders-tab">
                                        <table id="yearly-total-table" class="table table-sm dt-responsive w-100">
                                        </table>
                                    </div>

                                    <div class="tab-pane overflow-auto" id="work-program-activity" role="tabpanel"
                                         aria-labelledby="nav-holders-tab">
                                        <table id="activity-table" class="table table-sm dt-responsive w-100">
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="col-sm-12 col-xl-4">
                {% comment %} {% if tenement.project|is_read:member %}
{#                     TODO: Statistics Box #}
{#                     Appear in screen larger or equal to xl. Disappear otherwise #}

                    <div id="statistics_div_xl" class="mb-3 py-0">
                        <div id="statistics_card" class="card shadow ">
                            <div class="card-header mb-0">
                                Actions Overview -- Coming soon
                            </div>
                            <div class="card-body ">
                                <div class="card-body justify-content-between">
                                    <div class="d-flex justify-content-around ">
                                        <a class="btn btn-sm btn-ofx-green  mb-3 me-2" href="#" style="width:150px"><i
                                                class="fa-solid fa-file-lines  fa-fw "></i>Annual Report</a>
                                        <a class="btn btn-sm btn-ofx-red  mb-3" href="#" style="width:150px"><i
                                                class="fa-solid fa-money-bill-wave fa-fw "></i>&nbspExpenditure</a>
                                    </div>
                                    <div class="d-flex justify-content-around">
                                        <a class="btn btn-sm btn-ofx-green me-2" style="width:150px" href="#"><i
                                                class="fa-solid fa-seedling  fa-fw "></i>&nbspEA return</a>
                                        <a class="btn btn-sm btn-ofx-blue " style="width:150px" href="#"><i
                                                class="fa-solid fa-arrows-spin  fa-fw"></i>Renewal</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %} {% endcomment %}

                {# Tenement Map Box #}
                <div id ='tenement_map_box' class="col-12" style="height:200px">
                    <div class="card shadow w-100">
                        <div class="card-header font-weight-bold">Tenement Map</div>
                        <div class="card-body" id="tenement-map"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% with tenement.project as project %}

        {% if not project %}
            {# UNCLAIMED TENEMENT MODAL FORMS #}
            {% modalform id='claimTenement' title='Claim Tenement' method='POST' %}
                {% csrf_token %}
                {{ claimTenementForm.as_p }}
            {% endmodalform %}

        {% else %}

            {# TARGET MODALS #}
            {% modalform id='addEditTarget' title='Add Prospect' submit_text='Add' dynamic='true' %}
                {% csrf_token %}
                {{ createTargetForm.as_p }}
                <input type="hidden" id="id_target_id" name="target_id">
            {% endmodalform %}

            {% modalform id='deleteTarget' title='Remove Prospect' submit_text='Remove' submit_class='btn-ofx-red' dynamic='true' %}
                {% csrf_token %}
                <p>Remove <b id="name"></b> from the project?</p>
            {% endmodalform %}

            {# CLAIMED TENEMENT MODAL FORMS #}
            {% if project|is_write:member %}

                {% modalform id='createTask' title='Create Task' %}
                    {% csrf_token %}
                    {{ createTaskForm.as_p }}
                {% endmodalform %}

            {% endif %}

            {% if project|is_write:member %}
                {% modalform id='createWorkProgram' title='Create Work Program' %}
                    {% csrf_token %}
                    {{ createWorkProgramForm.as_p }}

                {% endmodalform %}
            {% endif %}
            {% if project|is_write:member %}
                {% modalform id='createWorkProgram' title='Create Work Program' %}
                    {% csrf_token %}
                    {{ createWorkProgramForm.as_p }}

                {% endmodalform %}
            {% endif %}

            {% if project|is_admin:member %}
                {% modalform id='modifyTenement' title='Modify Tenement' submit_text='Update' %}
                    {% csrf_token %}
                    {{ modifyTenementForm.as_p }}
                    {% comment %} <p>Coming Soon</p> {% endcomment %}
                {% endmodalform %}

                {% modalform id='deleteTenement' title='Relinquish Tenement' submit_class='Relinquish' submit_class='btn-ofx-red' %}
                    {% csrf_token %}
                    {{ deleteTenementForm.as_p }}
                    <p>Relinquish ownership of <b>{{ tenement.permit_id }}</b> from
                        its Project?
                    </p>
                    <p>This action will <strong class="text-ofx-red">permanently</strong> delete the following:</p>
                    <ul>
                        <li>All Tasks and associated files.</li>
                        <li>All Targets within the Tenement.</li>
                    </ul>
                {% endmodalform %}

                {% modalform id='deleteTask' title='Delete Task' submit_text='Remove' submit_class='btn-ofx-red' dynamic='true' %}
                    {% csrf_token %}
                    {{ deleteTaskForm.as_p }}
                    <p>Remove <b id="name"></b> from the tenement?</p>
                {% endmodalform %}

                {% modalform id='deleteWorkProgram' title='Delete Work Program' submit_text='Remove' submit_class='btn-ofx-red' dynamic='true' %}
                    {% csrf_token %}
                    {{ deleteWorkProgramForm.as_p }}
                    <p>Remove <b id="name"></b> from the work program?</p>
                {% endmodalform %}

                {% modalform id='createWorkProgramReceipt' title='Create Work Program Receipt' submit_text='Submit' dynamic='true' %}
                    {% csrf_token %}
                    {{ createWorkProgramReceipt.as_p }}

                {% endmodalform %}
            {% endif %}
        {% endif %}
    {% endwith %}

{% endblock %}


{% block extra_body %}
    <script type="text/javascript" src="{% static 'tms/js/tenement_dashboard.js' %}"></script>
    <script src="{% static 'interactive_map/js/api.js' %}" type="text/javascript"></script>

    <script>
        //$(window).resize(updateStatisticsCardPos)

        setTimeout(function () {
            if (document.getElementById("flash-message") !== null)
                document.getElementById("flash-message").style.display = "none";
        }, 3000);

        $('button[type="submit"]').on('click', function (event) {
            formId = event.target.form.id;
            const form = document.getElementById(formId);
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
                form.classList.add('was-validated');
            }

        });

    </script>
    <script>
        $(window).resize(updateStatisticsCardPos)

        $(document).ready(function () {
            updateStatisticsCardPos()

            {% if tenement.project|is_read:member %}
                let targetsTable = $('#target-table').DataTable({
                    'bSort': true,
                    'bPaginate': false,
                    'bDestroy': true,
                    columns: [
                        {data: 'name'},
                        {data: 'description'},
                        {data: 'location'},
                        {
                            data: 'actions', bSortable: false,

                            render: function (data, type, row) {
                                " {% if tenement.project|is_admin:member %}"
                                    return `<div class="float-end">
                                        <span data-bs-toggle="modal" data-bs-target="#addEditTargetModal">
                                            <button class="btn btn-ofx-fa btn-ofx-fa-gray" data-bs-toggle="tooltip" data-bs-placement="left" title="Edit Prospect">
                                                <span class="fa-sharp fa-solid fa-pen"/>
                                            </button>
                                        </span>
                                        <span data-bs-toggle="modal" data-bs-target="#deleteTargetModal">
                                            <button class="btn btn-sm btn-ofx-fa-red" data-bs-toggle="tooltip" data-bs-placement="left"
                                                    title="Delete Prospect">
                                                <span class="fa fa-trash"/>
                                            </button>
                                        </span></div>`;
                                    "   {% endif %}"
                            }

                        }
                    ],
                    ajax: {
                        url: "{% url 'tms:get_targets' permit_state=tenement.permit_state permit_type=tenement.permit_type permit_number=tenement.permit_number %}",
                        type: 'GET',
                        contentType: 'application/json',
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        dataSrc: function (response) {
                            for (let i = 0; i < response.data.length; i++) {
                                var coordinates = response.data[i].location.split(" ")
                                response.data[i].location = "[ " + coordinates[0] + ", " + coordinates[1] + " ]"
                            }
                            return response.data;
                        },
                    }
                });

                let taskTable = $('#task-table').DataTable({
                    'bSort': true,
                    'bPaginate': false,
                    'bDestroy': true,
                    order: [[4, "asc"]],
                    columns: [
                        {data: 'name', bSortable: true},
                        {data: 'description', bSortable: true},
                        {data: 'authority', bSortable: true},
                        {data: 'due_date', bSortable: true},
                        {
                            data: 'attachments', bSortable: false,
                            render: function (data, type, row) {
                                let files = data['files'];
                                let options = '';

                                $.each(files, function (i, file) {
                                    options += `
                                    <span class="dropdown-item">
                                        <a href="${file['url']}" download>${file['filename']}</a>
                                        <span class="text-sm text-ofx-gray">${file['size']}</span>
                                    </span>`
                                });

                                return options ? `
                                <div class="btn-group">
                                    <button class="btn btn-sm btn-ofx-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        ${files.length} Files (<span class="text-sm text-ofx-dark">${data['size']}</span>)
                                    </button>
                                    <div class="dropdown-menu">
                                        ${options}
                                    </div>
                                </div>` : ''
                            }
                        },
                        {
                            data: 'actions', bSortable: false,
                            {% if tenement.project|is_admin:member %}
                                mRender: function () {
                                    return `
                                <div class="float-end">
                                    <span data-bs-toggle="modal" data-bs-target="#deleteTaskModal">
                                        <button class="btn btn-ofx-fa btn-ofx-fa-red" data-bs-toggle="tooltip" data-bs-placement="left"
                                                title="Delete Task">
                                            <span class="fa fa-trash"/>
                                        </button>
                                    </span>
                                </div>`
                                }
                            {% endif %}
                        }
                    ],
                    ajax: {
                        url: "{% url 'tms:get_tasks' permit_state=tenement.permit_state permit_type=tenement.permit_type permit_number=tenement.permit_number %}",
                        type: 'GET',
                        contentType: 'application/json',
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        data: function (response) {
                            return response.data;
                        },
                    }
                });

                let workProgramTable = $('#activity-table').DataTable({
                    'bSort': true,
                    'bPaginate': false,
                    'bDestroy': true,
                    order: [[0, "asc"], [1, "asc"]],
                    columns: [
                        {data: 'year', title: 'Year', bSortable: true,},
                        {data: 'discipline', title: 'Discipline', bSortable: true,},
                        {data: 'activity', title: 'Activity', bSortable: true,},
                        {
                            data: 'units', title: 'Units', bSortable: true,
                            render: function (data, type, row) {
                                return `${data} ${row.units_display}`
                            }
                        },
                        {
                            data: 'quantity', title: 'Quantity', bSortable: true,
                            render: function (data, type, row) {
                                return `${data} ${row.quantity_display}`
                            }
                        },
                        {
                            data: 'expenditure', title: 'Expenditure', bSortable: true,
                            render: function (data, type, row) {
                                return `$${(data).toFixed(2)}`
                            }
                        },
                        {
                            data: 'actual_expenditure', title: 'Actual Expenditure', bSortable: true,
                            render: function (data, type, row) {
                                return `$${(data).toFixed(2)}`
                            }
                        },
                        {
                            data: 'receipts', title: 'Receipts', bSortable: false,
                            render: function (data, type, row) {
                                let files = data['files'];
                                let options = '';

                                $.each(files, function (i, file) {
                                    options += `
                                    <span class="dropdown-item">
                                        <a href="${file['url']}" download>${file['filename']}</a>
                                        <span class="text-sm text-ofx-gray">${file['size']}</span>
                                    </span>`
                                });

                                return options ? `
                                <div class="w-100">
                                    <button class="text-left btn btn-sm btn-ofx-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        ${files.length} Files (<span class="text-sm text-ofx-dark">${data['size']}</span>)
                                    </button>
                                    <div class="dropdown-menu">
                                        ${options}
                                    </div>
                                    {% if tenement.project|is_admin:member %}
                                        <span data-bs-toggle="modal" data-bs-target="#createWorkProgramReceiptModal">
                                            <button class="btn btn-ofx-fa btn-ofx-green float-end text-xs"
                                                    data-bs-toggle="tooltip" data-bs-placement="left" title="Add Receipt">
                                                <span class="fa fa-plus"/>
                                            </button>
                                        </span>
                                    {% endif %}
                                </div>` : `
                                {% if tenement.project|is_admin:member %}
                                    <span data-bs-toggle="modal" data-bs-target="#createWorkProgramReceiptModal">
                                        <button class="btn btn-ofx-fa btn-ofx-green float-end text-xs"
                                                data-bs-toggle="tooltip" data-bs-placement="left" title="Add Receipt">
                                            <span class="fa fa-plus"/>
                                        </button>
                                    </span>
                                {% endif %}`
                            }
                        },
                        {
                            data: 'actions', title: 'Actions', bSortable: false,
                            {% if tenement.project|is_admin:request.user %}
                                mRender: function () {
                                    return `
                                <div class="float-end">
                                    <span data-bs-toggle="modal" data-bs-target="#deleteWorkProgramModal">
                                        <button class="btn btn-ofx-fa btn-ofx-fa-red" data-bs-toggle="tooltip" data-bs-placement="left"
                                                title="Delete Work Program">
                                            <span class="fa fa-trash"/>
                                        </button>
                                    </span>
                                </div>`
                                }
                            {% endif %}
                        }
                    ],
                    ajax: {
                        url: "{% url 'tms:get_workload' permit_state=tenement.permit_state permit_type=tenement.permit_type permit_number=tenement.permit_number %}",
                        type: 'GET',
                        contentType: 'application/json',
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                        dataSrc: function (response) {
                            const records = response.data

                            // Calculate Actual Expenditure from receipts
                            records.forEach(entry => {
                                entry.actual_expenditure = 0
                                entry.receipts.files.forEach(receipt => {
                                    entry.actual_expenditure += receipt['cost']
                                });
                            })

                            // Calculate Yearly/Summary Totals
                            const yearlyTotals = {}
                            const summaryTotals = {}

                            records.forEach(entry => {
                                const year = entry.year;
                                const discipline = entry.discipline;

                                // Calculate Yearly Totals
                                if (!yearlyTotals[year]) {
                                    yearlyTotals[year] = {}
                                }
                                if (!yearlyTotals[year][discipline]) {
                                    // First entry can just be the first entry we have in the table
                                    yearlyTotals[year][discipline] = {
                                        year: entry.year,
                                        discipline: entry.discipline,
                                        quantity: entry.quantity,
                                        quantity_display: entry.quantity_display,
                                        units: entry.units,
                                        units_display: entry.units_display,
                                        expenditure: entry.expenditure,
                                        actual_expenditure: entry.actual_expenditure,
                                    }
                                } else {
                                    // Aggregate yearly totals
                                    yearlyTotals[year][discipline].units += entry.units;
                                    yearlyTotals[year][discipline].quantity += entry.quantity;
                                    yearlyTotals[year][discipline].expenditure += entry.expenditure;
                                    yearlyTotals[year][discipline].actual_expenditure += entry.actual_expenditure;
                                }

                                // Calculate Summary Total JSON
                                if (!summaryTotals[discipline]) {
                                    // First entry should set year at 1 in case the order has come in incorrectly
                                    summaryTotals[discipline] = {
                                        discipline: discipline,
                                        year: 1,
                                        quantity: entry.quantity,
                                        quantity_display: entry.quantity_display,
                                        units: entry.units,
                                        units_display: entry.units_display,
                                        expenditure: entry.expenditure,
                                        actual_expenditure: entry.actual_expenditure,
                                    }
                                } else {
                                    // Aggregate summary totals
                                    summaryTotals[discipline].year += (year > summaryTotals[discipline].year) ? 1 : 0;
                                    summaryTotals[discipline].units += entry.units;
                                    summaryTotals[discipline].quantity += entry.quantity;
                                    summaryTotals[discipline].expenditure += entry.expenditure;
                                    summaryTotals[discipline].actual_expenditure += entry.actual_expenditure;
                                }
                            });

                            // Flatten yearlyTotals/summaryTotals into arrays for datatable inputs
                            const yearlyTotalsArray = [];
                            const summaryTotalsArray = [];

                            for (const year in yearlyTotals) {
                                for (const discipline in yearlyTotals[year]) {
                                    yearlyTotalsArray.push(yearlyTotals[year][discipline]);
                                }
                            }
                            for (const discipline in summaryTotals) {
                                summaryTotalsArray.push(summaryTotals[discipline]);
                            }

                            // Define columns since both tables share the same columns
                            const totalColumns = [
                                {data: 'year', title: 'Year'},
                                {data: 'discipline', title: 'Discipline'},
                                {
                                    data: 'units', title: 'Units',
                                    render: function (data, type, row) {
                                        return `${data} ${row.units_display}`
                                    }
                                },
                                {
                                    data: 'quantity', title: 'Quantity',
                                    render: function (data, type, row) {
                                        return `${data} ${row.quantity_display}`
                                    }
                                },
                                {data: 'expenditure', title: 'Expenditure', render: data => `$${(data).toFixed(2)}`},
                                {
                                    data: 'actual_expenditure',
                                    title: 'Actual Expenditure',
                                    render: data => `$${(data).toFixed(2)}`
                                },
                            ]

                            // Build the yearly total table
                            $('#yearly-total-table').DataTable({
                                bSort: false,
                                bPaginate: false,
                                bDestroy: true,
                                columns: totalColumns,
                                data: yearlyTotalsArray
                            });

                            // Build the summary total table
                            $('#summary-total-table').DataTable({
                                bSort: false,
                                bPaginate: false,
                                bDestroy: true,
                                columns: totalColumns,
                                data: summaryTotalsArray
                            });

                            return records;
                        },
                    }
                });

            {% endif %}

            {% if not tenement.project %}
                $("#claimTenementForm").on('submit', function (e) {
                    e.preventDefault()
                    let $form = $(this)
                    let $modal = $form.closest('.modal')

                    $.ajax({
                        type: 'POST',
                        url: location.origin + location.pathname + `post/claim/`,
                        data: $form.serialize(),
                        success: function () {
                            window.location.reload();
                        },
                        error: function (response) {
                            $form.displayFormErrors(response['responseJSON']);
                        }
                    })
                })
            {% endif %}

            const tenementMap = $('#tenement-map').InteractiveMap({
                width: '100%',
                height: '0',
                paddingBottom: '80%',
                widgets: ['zoomButton', 'resetBounds'],
                layers: [
                    {
                        {# PROSPECT ENDPOINT #}
                        url: "{% url 'interactive_map:tenement_prospects' permit_state=tenement.permit_state permit_type=tenement.permit_type permit_number=tenement.permit_number %}",
                        tooltip: (feature) => feature.properties.name,
                    },
                    {
                        {# TENEMENT ENDPOINT #}
                        url: "{% url 'interactive_map:tenement' permit_state=tenement.permit_state permit_type=tenement.permit_type permit_number=tenement.permit_number %}",
                        tooltip: (feature) => {
                            const { permit_type, permit_number } = feature.properties;
    
                            return `${permit_type} ${permit_number}`;
                        },
                    },
                ]
            });
            
            
            const prospectMap = $('#target_map').InteractiveMap({
                width: '100%',
                height: '0',
                paddingBottom: '80%',
                widgets: ['zoomButton', 'createMark', 'resetBounds'],
                layers: [
                    {
                        {# TENEMENT ENDPOINT #}
                        url: "{% url 'interactive_map:tenement' permit_state=tenement.permit_state permit_type=tenement.permit_type permit_number=tenement.permit_number %}",
                    },
                ]
            });

            prospectMap.on(InteractiveMap.Event.Mark.created, function (e) {
                const { marker, lat, lng } = e.detail;

                marker.bindPopup(`
                                <table>
                                    <tbody>
                                        <tr><th>Latitude: </th><td>${lat}</td></tr>
                                        <tr><th>Longitude: </th><td>${lng}</td></tr>
                                    </tbody>
                                </table>
                            `).openPopup();
                $('#id_location').val(`${lat} ${lng}`);
                $('#id_location_input').val(`${lat} ${lng}`);
            });

            
            $('#addTargetButton').on('click',function (e) {
          
                setTimeout(function(){ 
                    prospectMap.widgets.createMark.clearLayers();
                    prospectMap.map.invalidateSize();
                    prospectMap.resetBounds();
                }, 200);
                $('#id_target_id').val('');
                $('#id_target_name').val('');
                $('#id_target_description').val('');
                $('#id_location').val('');
                $('#id_location_input').val('');
                $('#addEditTargetForm .modal-header').text('Add Prospect');
                $('#addEditTargetForm #btnSubmit').text('Add');
            });
            $('#target-table').on('click', 'button:has(.fa-pen)', function (e) {
                let tableRow = $('#target-table').DataTable().row($(this).parents('tr')).data();
                let location = tableRow['location'].replace(/(\[|\]|,)/gm,'')
                location = location.trim();
                
                $('#id_target_id').val(tableRow['name']);
                $('#id_target_name').val(tableRow['name']);
                $('#id_target_description').val(tableRow['description']);
                $('#id_location').val(location);
                $('#id_location_input').val(location);
                $('#addEditTargetForm .modal-header').text('Edit Prospect');
                $('#addEditTargetForm #btnSubmit').text('Save');

                var coordinates = location.split(" ")
                prospectMap.widgets.createMark.clearLayers();
                L.marker(coordinates).addTo(prospectMap.widgets.createMark);
                setTimeout(function(){ 
                    prospectMap.map.invalidateSize();
                    combinedBounds = prospectMap.getCombinedBounds().extend(prospectMap.widgets.createMark.getBounds());
                    prospectMap.fitBounds(combinedBounds, [])
                }, 200);
            });

            // TARGET FORMS

            $('#addEditTargetForm').on('submit', function (e) {
                e.preventDefault();
                let $form = $(this);
                let $table = $('#target-table');
                let tableRow = $table.DataTable().row($form.attr('row-index'));
                let url = $('#id_target_id').val() ? location.origin + location.pathname + `post/target/edit/`+tableRow.data()['name'] : location.origin + location.pathname + `post/target/add/`;
                let $modal = $form.closest('.modal');
                let $submitBtn = $form.find('[type="submit"]');
                let submitHtml = $submitBtn.html();
                
                $.ajax({
                    type: 'POST',
                    url: url,
                    data: $form.serialize(),
                    beforeSend: function (){
                        $submitBtn.addSpinner();
                        const overlay = document.createElement('div');
                        overlay.classList.add('overlay');
                        document.body.appendChild(overlay);
                    },
                    success: function (response) {
                        var coordinates = response.data.location.split(" ")
                        var marker = L.marker(coordinates)
                        if (turf.booleanIntersects(marker.toGeoJSON(), JSON.parse(response.tenement))) {
                            console.log('works')
                            response.data.location = "[ " + coordinates[0] +", " + coordinates[1] + " ]"
                            if ($('#id_target_id').val()){
                                $table.DataTable().row($form.attr('row-index')).data(response.data).draw();
                            }
                            else{
                                $table.DataTable().row.add(response.data).draw();
                            }
                        }
                        else{
                            if ($('#id_target_id').val()){
                                tableRow.remove().draw();
                            }
                        }

                        $modal.modal('hide');
                        $form.resetForm();  
                        tenementMap.reload();
                        
                    },
                    error: function (response) {
                        if(response['responseJSON']){
                            $form.displayFormErrors(response['responseJSON']);
                        }
                        else{
                            $form.displayFormErrors({'__all__': ['Target with this Project and Name already exists.']});
                        }
                        
                    },
                    complete: function () {
                        $submitBtn.removeSpinner(submitHtml);
                        const overlay = document.querySelector('.overlay');
                        document.body.removeChild(overlay);
                    }
                });
            });

            $('#addEditTargetModal').on("hidden.bs.modal", function() {
                $('#addEditTargetForm').resetForm();
            });

            $('#deleteTargetForm').on('submit', function (e) {
                e.preventDefault();
                let $form = $(this);
                let $table = $('#target-table');
                let $modal = $form.closest('.modal');
                let tableRow = $table.DataTable().row($form.attr('row-index'));
                let formData = new FormData($form[0]);
                formData.set('name', tableRow.data()['name']);

                $.ajax({
                    type: 'POST',
                    url: location.origin + location.pathname + `post/target/delete/`,
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function () {
                        tableRow.remove().draw();
                        $modal.modal('hide');
                        $form.resetForm();
                        tenementMap.reload();
                        
                    },
                    error: function (response) {
                        $form.displayFormErrors(response['responseJSON']);
                    }
                });
            });
        })



        let previousWidth = $(window).width();

        /**
         * Update statistics card position based on screen size
         *
         * Required by: $window.resize(), $document.ready
         *
         * @param {number} screen_size - Current screen size
         **/
        function updateStatisticsCardPos() {
            let currentWidth = $(window).width();

            // Min breakpoint size
            const breakpoint = {
                'sm': 576, 'md': 768,
                'lg': 992, 'xl': 1200, 'xxl': 1400
            }

            // True when changing breakpoint between xl and other smaller breakpoints
            const isDifferentBreakpoint = (previousWidth >= breakpoint.xl && currentWidth < breakpoint.xl)
                || (previousWidth < breakpoint.xl && currentWidth >= breakpoint.xl)

            if (currentWidth === previousWidth || isDifferentBreakpoint) {
                let card = $("#statistics_card").detach()
                $(currentWidth < breakpoint.xl ? "#statistics_div_small" : "#statistics_div_xl").append(card)
            }

            previousWidth = currentWidth
        }
    </script>
{% endblock %}